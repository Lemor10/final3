{% extends 'base_admin.html' %}
{% block title %}Notifications{% endblock %}

{% block styles %}
<style>
.notification-item:hover {
    transform: translateY(-2px);
    background-color: #f8f9fa;
}

.list-group-item .badge {
    font-size: 0.75rem;
}

h3 {
    color: #4DA6FF;
}

.notification-item {
  transition: all 0.35s ease;
}

.notification-item.fade-out {
  opacity: 0;
  transform: translateX(20px);
  height: 0;
  margin: 0;
  padding-top: 0;
  padding-bottom: 0;
  overflow: hidden;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-4">
    <button id="mark-all-read" class="btn btn-sm btn-primary">
        Mark All as Read
    </button>
</div>

{% if g.notifications %}
<div class="list-group">
  {% for notif in g.notifications %}
  <li data-id="{{ notif.id }}" class="list-group-item list-group-item-action mb-2 p-3 shadow-sm rounded d-flex justify-content-between align-items-center notification-item">
      <div class="d-flex align-items-start gap-3">
          <span class="fs-4">
              {% if notif.type == 'reminder' %}
                  <i class="bi bi-exclamation-triangle-fill text-warning"></i>
              {% elif notif.type == 'overdue' %}
                  <i class="bi bi-circle-fill text-danger"></i>
              {% endif %}
          </span>
          <div>
              <div class="fw-semibold">{{ notif.message }}</div>
              {% if notif.due_date %}
              <small class="text-muted">{{ notif.due_date.strftime('%b %d, %Y') }}</small>
              {% endif %}
          </div>
      </div>

      <div class="d-flex align-items-center gap-2">
          {% if not notif.is_read %}
          <span class="badge bg-primary py-1 px-2">New</span>
          {% endif %}
      </div>
  </li>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info rounded shadow-sm">No notifications at this time.</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.getElementById('mark-all-read')?.addEventListener('click', async () => {
    const unreadIds = Array.from(document.querySelectorAll('li[data-id]')).map(li => li.dataset.id);

    for(const id of unreadIds){
        await fetch(`/notifications/read/${id}`, { method: 'POST' });
        const li = document.querySelector(`li[data-id='${id}']`);
        li.querySelector('.badge')?.remove();
    }
    const dot = document.getElementById('notif-dot');
    if(dot) dot.classList.add('d-none');
});
document.querySelectorAll('.notification-item').forEach(item => {
    item.addEventListener('click', async () => {
        const notifId = item.dataset.id;
        const res = await fetch(`/notifications/read/${notifId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
            }
        });

        if(res.ok){
            item.querySelector('.badge')?.remove();
            const dot = document.getElementById('notif-dot');
            if(dot) dot.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}
