{% extends "base_owner.html" %}

{% block title %}Profile{% endblock %}

{% block styles %}
  <style>
    body {
      background: #f4f6f9;
      font-family: "Poppins", sans-serif;
    }
    .profile-photo {
      width: 145px;
      height: 145px;
      border-radius: 100%;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid #007bff;
    }
    .form-control:focus {
      box-shadow: 0 0 5px rgba(0, 123, 255, .4);
      border-color: #007bff;
    }
    .dog-card {
      padding: 1rem;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      flex-direction: column;
    }
    .dog-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.15);
    }

    .qr-preview img {
      display: block;
      margin: 0 auto;
    }
    .mb-3 { 
      margin-bottom: 0.8rem !important; 
    }

    .mt-2 { 
      margin-top: 0.8rem !important; 
    }

    .flex-wrap { 
      flex-wrap: wrap !important; 
    }

  input:disabled {
  background-color: #e9ecef;
  cursor: not-allowed;
}

.small-hint {
  font-size: 0.8rem;
  color: #6c757d;
}

.dog-img-wrapper {
  width: 100%;
}

.dog-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 20px;
  margin-bottom: 1rem;
}

@media (min-width: 768px) {
  .dog-img {
    height: 100%;
    min-height: 200px;
  }
  .dog-card {
    width:60%;
    margin-left: 25%;
  }

  .h3{
    margin-left: 25%;
  }
}

  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">

    <div class="col-lg-4 col-12 mb-4">
      <div class="profile-card" style="position: sticky; top: 20px;">
  <form action="{{ url_for('owner_profile') }}" method="POST" enctype="multipart/form-data">
    <div class="mb-3 text-center">
      <img src="{{ url_for('static', filename='profile_images/' ~ (current_user.profile_photo if current_user.profile_photo else 'default_profile.png')) }}"
           class="profile-photo"
           data-bs-toggle="modal"
           data-bs-target="#changePhotoModal"
           alt="Profile Photo">
      <p class="text-muted small">Click to change photo</p>
    </div>

    <div class="mb-3">
      <label>Full Name</label>
      <input type="text" name="name" class="form-control profile-input" value="{{ current_user.name }}" readonly>
    </div>
    <div class="mb-3">
      <label>Username</label>
      <input type="text" name="name" class="form-control profile-input" value="{{ current_user.username }}" readonly>
    </div>
    <div class="mb-3">
      <label>Email Address</label>
      <input type="email" class="form-control" value="{{ current_user.email if current_user.email else 'N/A' }}" readonly>
    </div>
    <div class="mb-3">
      <label>Contact Number</label>
      <input type="text" name="contact" class="form-control profile-input" value="{{ current_user.contact }}" readonly>
    </div>
    <div class="mb-3">
      <label>Owner Address</label>
      <input type="text" name="address" class="form-control profile-input" value="{{ current_user.address if current_user.address else 'N/A' }}" readonly>
    </div>
    <button type="button" id="editBtn" class="btn btn-outline-primary w-100 mt-3">Edit Profile</button>
    <div id="saveCancelBtns" class="mt-3 d-none">
      <button type="submit" class="btn btn-success w-100 mb-2">Save Changes</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary w-100">Cancel</button>
    </div>
  </form>
</div>

    </div>

    <div class="col-lg-8 col-12">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h3 class="text-primary">Your Registered Dogs</h3>
        <button class="btn btn-success btn-sm w-25 h-100" data-bs-toggle="modal" data-bs-target="#addDogModal">Register Dog</button>
      </div>

      <div class="row">
        {% for dog in dogs %}
        <div class="col-12 mb-4">
          <div class="dog-card card border-0 shadow-sm overflow-hidden rounded-4">
            <div class="row g-0">
              <div class="col-md-4 col-12 dog-img-wrapper">
                <img src="{{ url_for('static', filename='dog_images/' ~ (dog.image if dog.image else 'default_dog.png')) }}" class="dog-img" alt="{{ dog.name }}">
              </div>
              <div class="col-md-8 col-12">
                <div class="card-body">
                  <h5 class="card-title fw-bold text-primary mb-1 {% if dog.vaccinated=='Vaccinated' %}text-success bi bi-shield-check{% else %}text-danger bi bi-x-circle{% endif %}"> 
                    {{ dog.name }}
                  </h5>
                  <p class="text-muted small mb-1"><strong>Breed:</strong> {{ dog.breed }}</p>
                  <p class="text-muted small mb-1"><strong>Gender:</strong>
                    {% if dog.gender == 'Male' %}
                    <i class="bi bi-gender-male text-primary"></i>
                    {% elif dog.gender == 'Female' %}
                      <i class="bi bi-gender-female text-danger"></i>
                    {% else %}
                      N/A
                    {% endif %}
                  </p>
                  <p class="text-muted small mb-1"><strong>Age:</strong> {{ dog.age }}</p>
                    <p class="text-muted small mb-1"><strong>Last Vaccinated:</strong>
                      {{ dog.last_vaccination if dog.last_vaccination else "N/A" }}
                    </p>
                    <p class="text-muted small mb-2"><strong>Next Vaccination:</strong> 
                      {{ dog.next_vaccination if dog.next_vaccination else "N/A" }}
                    </p>
                    <p class="text-muted small mb-2">
                    <strong>Vaccination Address:</strong>
                    {% if dog.vaccination_barangay %}
                      {{ dog.vaccination_barangay }},
                      {{ dog.vaccination_municipality }},
                      {{ dog.vaccination_province }}
                    {% else %}
                      N/A
                    {% endif %}
                  </p>
                  <p class="text-muted small mb-2">
                    <strong>Vaccination Conducted At:</strong>
                    {% if dog.vaccination_location %}
                      {{ dog.vaccination_location }}
                    {% else %}
                      N/A
                    {% endif %}
                  </p>
                    <p class="text-muted small mb-2"><strong>Vaccination Expiry:</strong> {{ dog.vaccination_expiry if dog.vaccination_expiry else "N/A" }}</p>
                  {% if dog.qr_code %}
                  <a href="{{ url_for('download_qr', dog_uuid=dog.uuid) }}" class="btn btn-sm btn-primary w-50 mb-2">Download QR</a>
                  {% endif %}
                  <div class="row g-2 mt-2">
                    <div class="col-12 col-sm-6">
                      <button class="btn btn-outline-primary btn-sm w-100"
                              data-bs-toggle="modal"
                              data-bs-target="#editDogModal{{ dog.id }}">
                        Edit
                      </button>
                    </div>
                    <div class="col-12 col-sm-6">
                      <button type="button" 
                              class="btn btn-danger btn-sm w-100" 
                              data-bs-toggle="modal" 
                              data-bs-target="#deleteDogModal" 
                              onclick="setDeleteDogForm('{{ url_for('owner_delete_dog', dog_id=dog.id) }}')">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="col-12 text-center text-muted mt-5">
          <p>No dogs registered yet. üêæ</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="changePhotoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('owner_profile') }}" enctype="multipart/form-data">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Change Profile Picture</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>Select New Profile Picture</label>
          <input type="file" name="profile_photo" class="form-control" accept="image/*" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addDogModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('owner_add_dog') }}" enctype="multipart/form-data">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Add New Dog</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="text-start mb-2">
              <label class="form-label">Upload Dog Image</label>
              <input type="file" name="dog_image" class="form-control" accept="image/*">
<div class="alert alert-warning py-2 mt-2 d-flex align-items-center" role="alert">
  <i class="bi bi-exclamation-circle-fill me-2"></i>
  <small class="mb-0">
    Please upload a clear full-body photo of the dog.
  </small>
</div>
          </div>

          <div class="mb-3">
            <input type="text" name="name" class="form-control" placeholder="Name" required>
          </div>
          <div class="mb-3">
            <input type="text" name="breed" list="breed-list" class="form-control" placeholder="Breed" required>
          </div>
          <datalist id="breed-list">
            <option value="Aspin">
            <option value="Beagle">
            <option value="Bulldog">
            <option value="Chihuahua">
            <option value="Dalmatian">
            <option value="Doberman">
            <option value="German Shepherd">
            <option value="Golden Retriever">
            <option value="Husky">
            <option value="Labrador">
            <option value="Pomeranian">
            <option value="Pug">
            <option value="Rottweiler">
            <option value="Shih Tzu">
            <option value="Yorkshire Terrier">
            <option value="Mix Breed">
          </datalist>

          <div class="mb-3">
            <label>Birthdate</label>
            <input type="date" name="birthdate" class="form-control" required>
          </div>

          <div class="mb-3">
            <select name="gender" class="form-select" required>
              <option value="" disabled selected>Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <select name="status" class="form-select mb-2" id="addVaccinationStatus" required>
            <option value="" disabled selected>Select Vaccination Status</option>
            <option value="Vaccinated">Vaccinated</option>
            <option value="Not Vaccinated">Not Vaccinated</option>
          </select>

          <div class="mb-3">
            <label>Last Vaccination Date</label>
            <input type="date" name="last_vaccination" class="form-control" title="Dog must be vaccinated" id="addLastVaccination">
          </div>

          <div class="mb-3">
            <label>Next Vaccination Due</label>
            <input type="date" name="next_vaccination" class="form-control" title="Dog must be vaccinated"  id="addNextVaccination">
          </div>
          <div id="vaccinationLocationFields">

          <div class="mb-3">
            <label>Vaccinated Conducted At</label>
            <input type="text"
                  name="vaccination_location"
                  class="form-control"
                  id="addVaccinationLocation"
                  placeholder="In-house, Veterinary Clinic, Animal Hospital, DA Office, etc."
                  title="Dog must be vaccinated">
          </div>

  <div class="mb-3">
    <label>Vaccination Address:</label>
    <input type="text"
           name="vaccination_barangay"
           class="form-control"
           id="addVaccinationBarangay"
           title="Dog must be vaccinated" 
           placeholder="Barangay">
  </div>

  <div class="mb-3">
    <input type="text"
      name="vaccination_municipality"
      class="form-control"
      id="addVaccinationMunicipality"
      title="Dog must be vaccinated" 
      placeholder="Municipality">
  </div>

  <div class="mb-3">
    <input type="text"
      name="vaccination_province"
      class="form-control"
      id="addVaccinationProvince"
      title="Dog must be vaccinated"
      placeholder="Province">
  </div>
</div>
        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-success w-50">Add Dog</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% for dog in dogs %}
<div class="modal fade" id="editDogModal{{ dog.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('owner_edit_dog', dog_id=dog.id) }}" enctype="multipart/form-data">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Edit Dog</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3 text-center">
            <label class="form-label fw-bold">Upload Dog Image (optional)</label>
            <input type="file" name="dog_image" class="form-control" accept="image/*">
            {% if dog.image %}
            <img src="{{ url_for('static', filename='dog_images/' ~ dog.image) }}" class="img-fluid mt-2 rounded" style="max-height: 150px;">
            {% endif %}
          </div>

          <div class="mb-3">
            <input type="text" name="name" class="form-control" value="{{ dog.name }}" required>
          </div>

          <div class="mb-3">
            <input type="text" name="breed" list="breed-list" class="form-control" value="{{ dog.breed }}" required>
          </div>

          <div class="mb-3">
            <select name="gender" class="form-select" required>
              <option value="" disabled {{ 'selected' if not dog.gender }}>
                Select Gender
              </option>
              <option value="Male" {{ 'selected' if dog.gender == 'Male' }}>
                Male
              </option>
              <option value="Female" {{ 'selected' if dog.gender == 'Female' }}>
                Female
              </option>
            </select>
          </div>

        <div class="mb-3">
          <label>Birthdate</label>
          <input type="date" name="birthdate" class="form-control" value="{{ dog.birthdate|default('', true) }}">
        </div>

        </div>
        <div class="modal-footer d-flex justify-content-center">
          <button type="submit" class="btn btn-primary w-50">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- Dog Success Modal (Bootstrap-only) -->
<div class="modal fade" id="dogSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- Modal Body -->
      <div class="text-center bg-success text-white p-4 rounded-top">
        <i class="bi bi-check-circle-fill fs-1 mb-2"></i>
        <h5 class="fw-bold mb-1">Success!</h5>
        <p class="mb-0">Dog registered successfully! QR code has been generated.</p>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer justify-content-center border-0 pt-3">
        <button class="btn btn-success w-50 rounded-pill" data-bs-dismiss="modal">OK</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="deleteDogModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="deleteDogForm">

        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Delete Dog Record</h5>
        </div>

        <div class="modal-body">

          <p class="text-danger small">
            Please specify the reason for deleting this dog record.
            This will be reviewed by the admin.
          </p>

          <div class="mb-3">
            <label class="form-label">Reason for Deletion</label>
            <select name="delete_reason" class="form-select" required
                    onchange="toggleCauseField(this.value)">
              <option value="" disabled selected>Select reason</option>
              <option value="Death">Due to Death</option>
              <option value="Sold">Sold</option>
              <option value="Transferred">Transferred to another owner</option>
              <option value="Missing">Missing / Lost</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="mb-3 d-none" id="causeOfDeathField">
            <label class="form-label">Cause of Death</label>
            <input type="text"
                   name="delete_cause"
                   class="form-control"
                   placeholder="e.g. Rabies, Parvo, Old Age">
            <small class="text-muted">
              Please specify the cause if the dog died due to illness.
            </small>
          </div>

          <div class="alert alert-warning small mt-3">
            This action cannot be undone. The record will be archived.
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            Confirm Delete
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
    {% if category == "dog_success" %}
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const modalEl = document.getElementById("dogSuccessModal");
          if (modalEl) {
            const successModal = new bootstrap.Modal(modalEl);
            successModal.show();
          }
        });
      </script>
    {% endif %}
  {% endfor %}
{% endwith %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const editBtn = document.getElementById("editBtn");
  const saveCancelBtns = document.getElementById("saveCancelBtns");
  const cancelBtn = document.getElementById("cancelBtn");
  const inputs = document.querySelectorAll(".profile-input");

  if (editBtn) {
    editBtn.addEventListener("click", function () {
      inputs.forEach(i => i.readOnly = false);
      editBtn.classList.add("d-none");
      saveCancelBtns.classList.remove("d-none");
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener("click", function () {
      inputs.forEach(i => i.readOnly = true);
      editBtn.classList.remove("d-none");
      saveCancelBtns.classList.add("d-none");
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

function toggleVaccinationFields(
  statusEl,
  lastDateEl,
  nextDateEl,
  brgyEl,
  munEl,
  provEl,
  locationEl
) {
  if (!statusEl) return;

  const vaccinated = statusEl.value === "Vaccinated";

  [lastDateEl, nextDateEl, brgyEl, munEl, provEl, locationEl].forEach(el => {
    if (!el) return;
    el.disabled = !vaccinated;
    el.required = vaccinated;
    if (!vaccinated) el.value = "";
  });
}

const addStatus = document.getElementById("addVaccinationStatus");
const addLast = document.getElementById("addLastVaccination");
const addNext = document.getElementById("addNextVaccination");

const addBrgy = document.getElementById("addVaccinationBarangay");
const addMun = document.getElementById("addVaccinationMunicipality");
const addProv = document.getElementById("addVaccinationProvince");
const addLocation = document.getElementById("addVaccinationLocation");

if (addStatus) {
  toggleVaccinationFields(
    addStatus,
    addLast,
    addNext,
    addBrgy,
    addMun,
    addProv,
    addLocation
  );

  addStatus.addEventListener("change", () =>
    toggleVaccinationFields(
      addStatus,
      addLast,
      addNext,
      addBrgy,
      addMun,
      addProv,
      addLocation
    )
  );
}

});
</script>
<script>
function setDeleteDogForm(actionUrl) {
  document.getElementById("deleteDogForm").action = actionUrl;
}
</script>
<script>
function toggleCauseField(reason) {
  const causeField = document.getElementById("causeOfDeathField");
  if (reason === "Death") {
    causeField.classList.remove("d-none");
  } else {
    causeField.classList.add("d-none");
    causeField.querySelector("input").value = "";
  }
}
</script>

{% endblock %}
