{% extends 'base_owner.html' %}
{% block title %}Notifications{% endblock %}

{% block styles %}
<style>
.notification-item:hover {
    transform: translateY(-2px);
    background-color: #f8f9fa;
}

.mark-read-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.list-group-item .badge {
    font-size: 0.75rem;
}

h3 {
    color: #4DA6FF;
}

.notification-item {
  transition: all 0.35s ease;
}

.notification-item.fade-out {
  opacity: 0;
  transform: translateX(20px);
  height: 0;
  margin: 0;
  padding-top: 0;
  padding-bottom: 0;
  overflow: hidden;
}

</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-end align-items-center mb-4">
    <button id="mark-all-read" class="btn btn-sm btn-primary">
        Mark All as Read
    </button>
    </div>
</div>
</div>

<div id="notifications-container">
  {% if g.notifications %}
  <div class="list-group" id="notifications-list">
    {% for notif in g.notifications %}
    <li data-id="{{ notif.id }}"
        data-read="{{ 'true' if notif.is_read else 'false' }}"
        data-created-at="{{ notif.created_at.isoformat() }}"
        class="list-group-item list-group-item-action mb-2 p-3 shadow-sm rounded d-flex justify-content-between align-items-center notification-item"
        style="transition: transform 0.2s;">
      <div class="d-flex align-items-start gap-3">
          <span class="fs-4">
              {% if notif.type == 'reminder' %}
                  <i class="bi bi-exclamation-triangle-fill text-warning"></i>
              {% elif notif.type == 'overdue' %}
                  <i class="bi bi-circle-fill text-danger"></i>
              {% endif %}
          </span>
          <div>
              <div class="fw-semibold">{{ notif.message }}</div>
              <small class="text-muted">{{ notif.due_date.strftime('%b %d, %Y') }}</small>
          </div>
      </div>

      <div class="d-flex align-items-center gap-2">
          {% if not notif.is_read %}
          <span class="badge bg-primary py-1 px-2">New</span>
          {% endif %}
      </div>
    </li>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info rounded shadow-sm" id="no-notifications">No notifications at this time.</div>
  {% endif %}
</div>

<script>
document.getElementById('mark-all-read').addEventListener('click', async () => {
    const unreadIds = Array.from(document.querySelectorAll('li[data-id]')).map(li => li.dataset.id);

    for(const id of unreadIds){
        await fetch(`/notifications/read/${id}`, { method: 'POST' });
        const li = document.querySelector(`li[data-id='${id}']`);
        li.querySelector('.badge')?.remove();
        li.querySelector('.mark-read-btn')?.remove();
    }

    updateNotifDot();
});

    async function fetchNotificationCount() {
      const res = await fetch("/api/notification-count");
      const data = await res.json();
      const dot = document.getElementById("notif-dot");
      if (dot) dot.classList.toggle("d-none", data.count === 0);
    }

    function setupNotificationItems() {
      const readNotifications =
        JSON.parse(localStorage.getItem("readNotifications") || "[]");

      document.querySelectorAll(".notification-item").forEach(item => {
        const id = item.dataset.id;

        if (readNotifications.includes(id)) {
          item.remove();
        }

        item.querySelector(".mark-read-btn")?.addEventListener("click", () => {
          readNotifications.push(id);
          localStorage.setItem(
            "readNotifications",
            JSON.stringify(readNotifications)
          );
          item.remove();
          updateDotDisplay();
        });
      });

      updateDotDisplay();
    }
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

    // Function to remove a notification with fade
    function removeNotification(li) {
        li.classList.add("fade-out");
        setTimeout(() => {
            li.remove();
            checkEmptyNotifications();  // âœ… update alert
        }, 400); // match CSS transition
    }

    // Periodically fetch old notifications to delete
    setInterval(async () => {
        try {
            const res = await fetch("/notifications/cleanup", {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });
            const data = await res.json();
            if(data.success){
                // Remove notifications from DOM if older than limit
                const now = new Date();
                document.querySelectorAll("li.notification-item").forEach(li => {
                    const createdAt = new Date(li.dataset.createdAt);
                    const read = li.dataset.read === "true";
                    const ageMinutes = (now - createdAt)/60000;
                    if((read && ageMinutes > 1) || (!read && ageMinutes > 2)){
                        removeNotification(li);
                        updateNotifDot();
                    }
                });
            }
        } catch(err){
            console.error("Cleanup failed:", err);
        }
    }, 30000); // every 30 seconds

});
function checkEmptyNotifications() {
    const list = document.getElementById("notifications-list");
    const alert = document.getElementById("no-notifications");

    if(list && list.children.length === 0){
        if(!alert){
            const container = document.getElementById("notifications-container");
            const div = document.createElement("div");
            div.id = "no-notifications";
            div.className = "alert alert-info rounded shadow-sm mt-3";
            div.innerText = "No notifications at this time.";
            container.appendChild(div);
        }
    } else if(alert){
        alert.remove();
    }
}

</script>

{% endblock %}